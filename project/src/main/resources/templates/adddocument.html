<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Добавление нового документа</title>
    <link rel="stylesheet" type="text/css" href="/css/adddocumentstyle.css">
</head>
<body>

    <form action="adddocument.html" th:action="@{/insertdocument}" th:method="POST" th:object="${insertDocument}">
        <h2 class="h2-text-title">Добавление нового документа</h2>

        <div class="div-row">
            <label for="type-document">Выберите тип документа:</label>
            <select id="type-document" th:field="${insertDocument.typeDocumentId}">
                <option th:each="typedoc: ${type_doc}" th:value="${typedoc.typedocid}" th:text="${typedoc.typedocname}"></option>
            </select>
        </div>

        <div class="div-row">
            <label for="category-parent">Выберите раздел:</label>
            <select id="category-parent" onchange="getAllCatChild()">
                <option th:each="catparent: ${category_parent}" th:value="${catparent.catid}" th:text="${catparent.catnamerus}" ></option>
            </select>
        </div>

<script>
    function getAllCatChild() {
        const catParentId = document.getElementById("category-parent").value
        const childrenSelect = document.getElementById("category-child")

        childrenSelect.innerHTML = "";

        fetch("/api/catchild/" + catParentId, {
            method: 'GET'})
        .then(rawResponse => rawResponse.json())
        .then(json => json.forEach(child => {
            childrenSelect.add(new Option(child.catnamerus, child.catid, child.ownerid, false,
                child.ownerid === catParentId.value));
            childrenSelect.innerHTML += childrenSelect;}))
    };
</script>

        <div class="div-row">
            <label for="category-child">Выберите подраздел:</label>
            <select id="category-child" th:field="${insertDocument.categoryId}" name="categoriesId">
            </select>
        </div>

        <div class="div-row">
            <label for="document-name">Введите наименование документа:</label>
            <input id="document-name" name="docname" type="text" th:value="*{docname}">
        </div>

        <div class="div-row">
            <label for="document-author">Введите автора/издательство:</label>
            <input id="document-author" name="docauthor" type="text" th:value="*{docauthor}">
        </div>

        <div class="div-row">
            <label for="document-year">Введите год издания:</label>
            <input id="document-year" name="docyear" type="text" th:value="*{docyear}">
            <div class="errors" th:if="${#fields.hasErrors('docyear')}" th:errors="*{docyear}">Wrong book title error</div>
        </div>

        <div class="div-row">
            <label for="document-pdf">Источник:</label>
            <input type="file" id="document-pdf" name="docistochnik" th:value="*{docistochnik}" accept=".pdf">
            <div class="errors" th:if="${#fields.hasErrors('docistochnik')}" th:errors="*{docistochnik}">Wrong book title error</div>
        </div>

        <div class="div-row">
            <label for="document-annotation">Аннотация:</label>
            <input id="document-annotation" name="docannotation" type="text" th:value="*{docannotation}">
        </div>

        <div class="div-row">
            <label for="document-key-word">Ключевые слова:</label>
            <input id="document-key-word" name="dockeyword" type="text" th:value="*{dockeyword}">
        </div>

        <div class="div-row-button">
            <button type="submit">Сохранить</button>
            <a href="main.html" th:href="@{/}"><button type="button">Отмена</button></a>
        </div>

    </form>

    <script>
        window.onload = async () => {
            const catParentId = document.getElementById("category-parent")
<!--                alert(catParentId.value)-->

            const childrenSelect = document.getElementById("category-child");
            const children = await fetchAllCatChild(catParentId.value);
            children.forEach(child => {
            childrenSelect.add(new Option(child.catnamerus, child.catid, child.ownerid, false,
                               child.ownerid === catParentId.value))
            });
}
            async function fetchAllCatChild(catid) {
                const response = await fetch("/api/catchild/" + catid);
                const children = await response.json();
                return children;
            }

    </script>

</body>
</html>